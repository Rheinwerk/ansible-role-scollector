---

- name: Install scollector package
  apt: name=bosun-scollector state={{ install_state|default('present') }}

- name: Add packagecloud gpg key for lukaspustina repository
  apt_key: id=D59097AB url=https://packagecloud.io/lukaspustina/opensource/gpgkey state=present

- name: Add lukaspustina opensource repository
  apt_repository: repo="deb https://packagecloud.io/lukaspustina/opensource/ubuntu/ trusty main" state=present
  register: repo_added

- name: Apt Update
  apt: update_cache=yes
  when: RW_APT_CACHE_UPDATE is defined or repo_added|changed

- set_fact:
    install_state: latest
  when: RW_ENABLE_DOWNLOADS is defined

- name: Install recommended tools
  apt: pkg="{{ item }}" state=present
  with_items:
    - bosun-emitter
    - jq

- name: Create scollector configuration file
  template: src="{{ item }}.j2" dest="/{{ item }}" owner=root group=root mode=0640
  with_items:
    - "etc/bosun/scollector.conf"
  notify:
    - Restart scollector

- block:

    - name: Create external collectors directory
      file: path={{ _scollector.external_collectors.dir }} state=directory owner=root group=root mode=0755

    - name: Create external collectors interval directories
      file: path={{ _scollector.external_collectors.dir }}/{{ item.interval }} state=directory owner=root group=root mode=0755
      with_items: "{{ _scollector.external_collectors.collectors }}"
      notify:
        - Restart scollector

    - name: Create external collectors
      template: src="external_collectors/{{ item.template }}" dest="{{ _scollector.external_collectors.dir }}/{{ item.interval }}/{{ item.filename }}" owner=root group=root mode=0750
      with_items: "{{ _scollector.external_collectors.collectors }}"
      notify:
        - Restart scollector

    - name: Create Meta Data Announcement Script for external collector metrics
      template: src="external_collectors/update-metric-metadata.sh.j2" dest="{{ _scollector.external_collectors.dir }}/update-metric-metadata.sh" owner=root group=root mode=0755

  when: _scollector.external_collectors is defined

